{
  "version": 3,
  "sources": ["../../../../../Modules/Administration/Translation/TranslationPage.ts", "../../../../../Modules/Administration/Translation/TranslationGrid.ts"],
  "sourcesContent": ["import { initFullHeightGridPage } from \"@serenity-is/corelib\"\r\nimport { TranslationGrid } from \"./TranslationGrid\";\r\n\r\n$(function() {\r\n    initFullHeightGridPage(new TranslationGrid($('#GridDiv')).element);\r\n});", "import { Decorators, EntityGrid, GridUtils, LookupEditor, LookupEditorOptions, ToolButton, Widget } from \"@serenity-is/corelib\";\r\nimport { confirm, isEmptyOrNull, isTrimmedEmpty, notifySuccess, outerHtml, localText, trimToEmpty, trimToNull } from \"@serenity-is/corelib\";\r\nimport { Column } from \"@serenity-is/sleekgrid\";\r\nimport { TranslationItem, TranslationService } from \"../\";\r\n\r\n@Decorators.registerClass()\r\nexport class TranslationGrid extends EntityGrid<TranslationItem, any> {\r\n    protected getIdProperty() { return \"Key\"; }\r\n    protected getLocalTextPrefix() { return \"Administration.Translation\"; }\r\n    protected getService() { return TranslationService.baseUrl; }\r\n\r\n    private hasChanges: boolean;\r\n    private searchText: string;\r\n    private sourceLanguage: LookupEditor; \r\n    private targetLanguage: LookupEditor;\r\n    private targetLanguageKey: string;\r\n\r\n    constructor(container: JQuery) {\r\n        super(container);\r\n\r\n        this.element.on('keyup.' + this.uniqueName + ' change.' + this.uniqueName,\r\n            'input.custom-text', e =>\r\n        {\r\n            var value = trimToNull($(e.target).val());\r\n            if (value === '') {\r\n                value = null;\r\n            }\r\n            this.view.getItemById($(e.target).data('key')).CustomText = value;\r\n            this.hasChanges = true;\r\n        });\r\n    }\r\n\r\n    protected onClick(e: JQueryEventObject, row: number, cell: number): any {\r\n        super.onClick(e, row, cell);\r\n\r\n        if (e.isDefaultPrevented()) {\r\n            return;\r\n        }\r\n\r\n        let item = this.itemAt(row);\r\n        let done: () => void;\r\n\r\n        if ($(e.target).hasClass('source-text')) {\r\n            e.preventDefault();\r\n                \r\n            done = () => {\r\n                item.CustomText = item.SourceText;\r\n                this.view.updateItem(item.Key, item);\r\n                this.hasChanges = true;\r\n            };\r\n\r\n            if (isTrimmedEmpty(item.CustomText) ||\r\n                (trimToEmpty(item.CustomText) === trimToEmpty(item.SourceText))) {\r\n                done();\r\n                return;\r\n            }\r\n\r\n            confirm(localText('Db.Administration.Translation.OverrideConfirmation'), done);\r\n            return;\r\n        }\r\n\r\n        if ($(e.target).hasClass('target-text')) {\r\n            e.preventDefault();\r\n\r\n            done = () => {\r\n                item.CustomText = item.TargetText;\r\n                this.view.updateItem(item.Key, item);\r\n                this.hasChanges = true;\r\n            };\r\n\r\n            if (isTrimmedEmpty(item.CustomText) ||\r\n                (trimToEmpty(item.CustomText) === trimToEmpty(item.TargetText))) {\r\n                done();\r\n                return;\r\n            }\r\n\r\n            confirm(localText('Db.Administration.Translation.OverrideConfirmation'), done);\r\n            return;\r\n        }\r\n    }\r\n\r\n    protected getColumns(): Column[] {\r\n\r\n        var columns: Column[] = [];\r\n        columns.push({ field: 'Key', width: 300, sortable: false });\r\n\r\n        columns.push({\r\n            field: 'SourceText',\r\n            width: 300,\r\n            sortable: false,\r\n            format: ctx => {\r\n                return outerHtml($('<a/>')\r\n                    .addClass('source-text')\r\n                    .text(ctx.value || ''));\r\n            }\r\n        });\r\n\r\n        columns.push({\r\n            field: 'CustomText',\r\n            width: 300,\r\n            sortable: false,\r\n            format: ctx => outerHtml($('<input/>')\r\n                .addClass('custom-text')\r\n                .attr('value', ctx.value)\r\n                .attr('type', 'text')\r\n                .attr('data-key', ctx.item.Key))\r\n        });\r\n\r\n        columns.push({\r\n            field: 'TargetText',\r\n            width: 300,\r\n            sortable: false,\r\n            format: ctx => outerHtml($('<a/>')\r\n                .addClass('target-text')\r\n                .text(ctx.value || ''))\r\n        });\r\n\r\n        return columns;\r\n    }\r\n\r\n    protected createToolbarExtensions(): void {\r\n        super.createToolbarExtensions();\r\n\r\n        let opt: LookupEditorOptions = {\r\n            lookupKey: 'Administration.Language'\r\n        };\r\n\r\n        this.sourceLanguage = Widget.create({\r\n            type: LookupEditor,\r\n            element: el => el.appendTo(this.toolbar.element).attr('placeholder', '--- ' +\r\n                localText('Db.Administration.Translation.SourceLanguage') + ' ---'),\r\n            options: opt\r\n        });\r\n\r\n        this.sourceLanguage.changeSelect2(e => {\r\n            if (this.hasChanges) {\r\n                this.saveChanges(this.targetLanguageKey).then(() => this.refresh());\r\n            }\r\n            else {\r\n                this.refresh();\r\n            }\r\n        });\r\n\r\n        this.targetLanguage = Widget.create({\r\n            type: LookupEditor,\r\n            element: el => el.appendTo(this.toolbar.element).attr('placeholder', '--- ' +\r\n                localText('Db.Administration.Translation.TargetLanguage') + ' ---'),\r\n            options: opt\r\n        });\r\n\r\n        this.targetLanguage.changeSelect2(e => {\r\n            if (this.hasChanges) {\r\n                this.saveChanges(this.targetLanguageKey).then(() => this.refresh());\r\n            }\r\n            else {\r\n                this.refresh();\r\n            }\r\n        });\r\n    }\r\n\r\n    protected saveChanges(language: string): PromiseLike<any> {\r\n        var translations: { [key: string]: string } = {};\r\n        for (let item of this.getItems()) {\r\n            translations[item.Key] = item.CustomText;\r\n        }\r\n\r\n        return Promise.resolve(TranslationService.Update({\r\n            TargetLanguageID: language,\r\n            Translations: translations\r\n        })).then(() => {\r\n            this.hasChanges = false;\r\n            language = trimToNull(language) || 'invariant';\r\n            notifySuccess('User translations in \"' + language +\r\n                '\" language are saved to \"user.texts.' +\r\n                language + '.json\" ' + 'file under \"~/App_Data/texts/\"', '');\r\n        });\r\n    }\r\n\r\n    protected onViewSubmit(): boolean {\r\n        var request = this.view.params;\r\n        request.SourceLanguageID = this.sourceLanguage.value;\r\n        this.targetLanguageKey = this.targetLanguage.value || '';\r\n        request.TargetLanguageID = this.targetLanguageKey;\r\n        this.hasChanges = false;\r\n        return super.onViewSubmit();\r\n    }\r\n    \r\n    protected getButtons(): ToolButton[] {\r\n        return [{\r\n            title: localText('Db.Administration.Translation.SaveChangesButton'),\r\n            onClick: e => this.saveChanges(this.targetLanguageKey).then(() => this.refresh()),\r\n            cssClass: 'apply-changes-button'\r\n        }];\r\n    }\r\n\r\n    protected createQuickSearchInput() {\r\n        GridUtils.addQuickSearchInputCustom(this.toolbar.element,\r\n            (field, searchText) => {\r\n                this.searchText = searchText;\r\n                this.view.setItems(this.view.getItems(), true);\r\n            });\r\n    }\r\n\r\n    protected onViewFilter(item: TranslationItem) {\r\n        if (!super.onViewFilter(item)) {\r\n            return false;\r\n        }\r\n\r\n        if (!this.searchText) {\r\n            return true;\r\n        }\r\n\r\n        var sd = Select2.util.stripDiacritics;\r\n        var searching = sd(this.searchText).toLowerCase();\r\n\r\n        function match(str: string) {\r\n            if (!str)\r\n                return false;\r\n\r\n            return str.toLowerCase().indexOf(searching) >= 0;\r\n        }\r\n\r\n        return isEmptyOrNull(searching) || match(item.Key) || match(item.SourceText) ||\r\n            match(item.TargetText) || match(item.CustomText);\r\n    }\r\n\r\n    protected usePager() {\r\n        return false;\r\n    }\r\n}"],
  "mappings": "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",
  "names": ["import_corelib", "import_corelib", "TranslationGrid", "container", "e", "value", "TranslationService", "row", "cell", "item", "done", "__name", "columns", "ctx", "opt", "el", "language", "translations", "request", "field", "searchText", "sd", "searching", "match", "str", "__decorateClass", "TranslationGrid"]
}
